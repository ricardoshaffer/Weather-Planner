<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://api.mqcdn.com/sdk/mapquest-js/v1.3.1/mapquest.js"></script> 
    <link type="text/css" rel="stylesheet" href="https://api.mqcdn.com/sdk/mapquest-js/v1.3.1/mapquest.css"/> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <title>Document</title>
    <style>
      .button.is-success.is-outlined:hover{
        color: #f15025;
        border-color: #f14025;
        background-color: rgba(0,0,0,0);
      }
      .button.is-success.is-outlined{
        color: #fff;
        border-color: #f14025;
        background-color: #f14025;
      }
      .has-background-black-ter{
        background-color: #e6e8e6 !important;
      }
      .navbar.has-background-black{
        background-color: #a4bab7 !important;
      }
    </style>
</head>
<body>
<nav class="bd-navbar navbar has-shadow is-spaced has-background-black has-text-white">
  <div class="container">
    <div class="navbar-brand"></div>
    <div class="navbar-menu">
      <div class="navbar-start"></div>
    </div>
  </div>
</nav>
<section class="section has-background-black-ter">
  <div class="container">
    <div class="columns is-desktop">
      <div class="column">
        <button class="button is-success is-outlined is-rounded is-medium is-fullwidth" id="location-finder">find my park!</button>
      </div>
      <div class="column is-three-quarters-tablet is-three-quarters-desktop is-two-thirds-widescreen is-three-quarters-fullhd">
        <section class="hero is-large">
          <div class="hero-body" id="map">
            <div class="container">
              <h1 class="title">
                Large title
              </h1>
              <h2 class="subtitle">
                Large subtitle
                <img src="https://cdn.shopify.com/s/files/1/0251/2525/7269/files/cat-calming-treats-shopping-icon-no-bkg_1080x.png?v=1579646732" height="400px">
              </h2>
            </div>
          </div>
        </section>
        <!-- <div id="map" style="width: 100%; height: 450px;"></div> -->
      </div>
    </div>
    </div>
    </section>
    
    <p id="mapperID"></p>
    <!-- <form>
        <input class="uk-input uk-form-width-medium uk-form-large" id="activitySearch" type="text" placeholder="Enter state Code">
    </form> -->



    <footer class="footer">
      <div class="content has-text-centered">
        <p>the parkFindr.
        </p>
      </div>
    </footer>


    <script>

//// SECION FOR THE EVENT LISTENER FOR KEYPRESS //////
//document.addEventListener("keypress", function(event){
  //if(event.key === 'Enter' || event.key === 'Return'){
  $("#location-finder").on("click", function(event) {
    event.preventDefault();
/// PROMPTS FOR PERMISSION TO USE PERMISSION /////
  getLocation();
  let locatorText = document.getElementById("mapperID");
  function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
    } else { 
    locatorText.innerHTML = "Geolocation is not supported by this browser.";
    }
  }
//// gets the address of the user by permission ///
  function showPosition(position) {
      locatorText.innerHTML = "Latitude: " + position.coords.latitude + 
      "<br>Longitude: " + position.coords.longitude;
      console.log("the position: " + position);
      let activityName = document.getElementById("activitySearch");
      let textBox = document.querySelector("#activitySearch");  
      //stateSearch = activityName.value;
// gets state for NPS api
      $.get('https://ipapi.co/ip/', function(data){
          let ipFetched = data;
          console.log("user IP: " + ipFetched);
          let ipEmbed = "https://ipapi.co/" + ipFetched + "/json/";
      $.getJSON(ipEmbed, function(data){
          let ipTrace = data;
          console.log(ipTrace);
          stateLocation = ipTrace.region_code;
          console.log("state location: "+ stateLocation);
/// SETS NPS API USING IPAPI.CO STATE IDENTIFICATION ///
  let limitResults = "&limit=50";
  let apiKey = "C20X2gP148EDeslk7stqM8BU6u6WmOqbAdPeKG8C";
  let queryURL = "https://developer.nps.gov/api/v1/parks?stateCode="+ stateLocation +"&limit=5&api_key=C20X2gP148EDeslk7stqM8BU6u6WmOqbAdPeKG8C";
//// GENERATES a mapquest map utilizing the lat & long of the user ///
  L.mapquest.key = 'm6r48gcKnaiZ5cS9fynPUC8mEcXnoOjO';
    let map = L.mapquest.map('map', {
    center: [position.coords.latitude, position.coords.longitude],
    layers: L.mapquest.tileLayer('dark'),
    zoom: 10,
    opacity: 0.7
    });
  L.marker([position.coords.latitude, position.coords.longitude], {
    icon: L.mapquest.icons.marker(),
    draggable: false
    }).addTo(map);
/// CALLS NPS API 
  $.ajax({ //
    url: queryURL, 
    method: "GET"
  }).then(function(response){
    let npsResponse = response;
    console.log(npsResponse);
    for(entry=0; entry < 10; entry++){
        parkTitle = npsResponse.data[entry].fullName;
        parkLatLong = (npsResponse.data[entry].latLong).replace("{", "").replace("}","");
        if(parkLatLong != ''){
        parkLatLong = parkLatLong.split(',');
        parkLat = (parkLatLong[0])
        let parkLatClean = parkLat.replace("lat:", "");
        parkLong = (parkLatLong[1])
        let parkLongClean = parkLong.replace("long:", "");
/// adds marker to the map for 'X' AMOUNT OF LOCATIONS FROM NPS FOR THE STATE ///
L.marker([parkLatClean, parkLongClean], {
          icon: L.mapquest.icons.marker({
            shadow: true,
            tooltip: parkTitle,
            primaryColor: '#f14025',
            secondaryColor: '#a4bab7'
          }),
          draggable: false
        }).addTo(map);


//CALCULATES THE DISTANCE FROM THE USER'S LOCATION TO THAT OF THE NPS LOCATION USING LAT & LONG//
function distanceMeasurement (){
    let radlat1 = Math.PI * (position.coords.latitude)/180;
    let radlat2 = Math.PI * parkLatClean/180;
    let theta =  position.coords.longitude - parkLongClean;
    //console.log("distance long 1: " + position.coords.longitude + "distance lat 2: "+ parkLatClean);
    let radtheta = Math.PI * theta/180;
		let distOne = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    dist = Math.acos(distOne);
		distTwo = dist * 180/Math.PI;
    distUnitless = distTwo * 60 * 1.1515;
    
    distKM = distUnitless * 1.609344;
    distMiles = (distKM / 1.6093444);
    distMiles = distMiles.toFixed(1);
    console.log("the distance in miles: " + distMiles);
    return distMiles;
    
}
distanceMeasurement();
    console.log("parkTitle response: " + parkTitle+ ",distance in miles from current location: "+ distMiles);
          }
        }
  })
    })
    })

  }})
        
</script>
</body>
</html>